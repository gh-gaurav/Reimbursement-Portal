{% extends 'base.html' %}

{% block content %}
    {% if user.role == 'Manager' %}
        <h1>Welcome to the Manager Dashboard, {{ user.username }}</h1>
        <p>Full Name: {{ user.first_name }} {{ user.last_name }}</p>
        <p>Email: {{ user.email }}</p>
        <p>Role: {{ user.role }}</p>
        <form id="logoutForm" action="/logout" method="post">
            <button type="submit">Logout</button>
        </form>
        <h2>Pending Reimbursement Requests</h2>
        <div id="requestsContainer"></div>
        <script>
            function redirectToHome() {
                window.location.href = "/";
            }

            document.getElementById("logoutForm").addEventListener("submit", function(event) {
                event.preventDefault();
                fetch("/logout", { method: "POST" })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            redirectToHome();
                        } else {
                            console.error("Logout failed:", data.message);
                        }
                    })
                    .catch(error => {
                        console.error("Error during logout:", error);
                    });
            });

            function fetchReimbursementRequests() {
                fetch("/api/reimbursement_requests")
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById("requestsContainer");
                        container.innerHTML = "";
                        data.forEach(req => {
                            const reqDiv = document.createElement("div");
                            reqDiv.className = "request";
                            reqDiv.innerHTML = `
                                <form class="requestForm" data-id="${req.id}">
                                    <p>ID: ${req.id}</p>
                                    <p>Amount: ${req.amount}</p>
                                    <p>Date: ${req.date}</p>
                                    <p>Description: ${req.description}</p>
                                    <p>Category: ${req.category}</p>
                                    <p>Status: 
                                        <select class="statusSelect" name="status">
                                            <option value="Pending" ${req.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Approved" ${req.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                            <option value="Rejected" ${req.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                        </select>
                                    </p>
                                    <p>Manager Comment: 
                                        <input type="text" class="managerComment" name="manager_comment" value="${req.manager_comment || ''}">
                                    </p>
                                    <button type="submit">Update</button>
                                </form>
                            `;
                            container.appendChild(reqDiv);
                        });
                        document.querySelectorAll(".requestForm").forEach(form => {
                            form.addEventListener("submit", function(event) {
                                event.preventDefault();
                                const id = this.getAttribute("data-id");
                                const status = this.querySelector(".statusSelect").value;
                                const manager_comment = this.querySelector(".managerComment").value;
                                updateReimbursementRequest(id, status, manager_comment);
                            });
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching requests:", error);
                    });
            }

            function updateReimbursementRequest(id, status, manager_comment) {
                fetch(`/api/reimbursement_requests/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ status, manager_comment })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    fetchReimbursementRequests();
                })
                .catch(error => {
                    console.error("Error updating request:", error);
                });
            }

            document.addEventListener("DOMContentLoaded", function() {
                fetchReimbursementRequests();
            });
        </script>
    {% else %}
        <h1>Access Denied</h1>
        <p>You do not have permission to access this page.</p>
    {% endif %}
{% endblock %}
