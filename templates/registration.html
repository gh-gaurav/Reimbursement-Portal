{% extends 'base.html' %} {% block content %}

<h1>Registration</h1>
<form id="registrationForm" onsubmit="registerUser(event)" class="needs-validation" novalidate>
    <div class="mb-3">
        <label for="username" class="form-label">Username:</label>
        <input type="text" id="username" name="username" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="email" class="form-label">Email:</label>
        <input type="email" id="email" name="email" class="form-control" required>
    </div>
    <div class="mb-3 password-container">
        <label for="password" class="form-label">Password:</label>
        <input type="password" id="password" name="password" class="form-control" required>
        <span class="toggle-password" onclick="togglePasswordVisibility('password')">&#x1F441;</span>
    </div>
    <div class="mb-3 password-container">
        <label for="confirm_password" class="form-label">Confirm Password:</label>
        <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
        <span class="toggle-password" onclick="togglePasswordVisibility('confirm_password')">&#x1F441;</span>
    </div>
    <div class="mb-3">
        <label for="role" class="form-label">Role:</label>
        <select id="role" name="role" class="form-select" required>
            <option value="">Select</option>
            <option value="Manager">Manager</option>
            <option value="Employee">Employee</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="first_name" class="form-label">First Name:</label>
        <input type="text" id="first_name" name="first_name" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="last_name" class="form-label">Last Name:</label>
        <input type="text" id="last_name" name="last_name" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="department" class="form-label">Department:</label>
        <select id="department" name="department_id" class="form-select" required>
            <option value="">Select</option>
            <!-- Department options will be populated dynamically -->
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Register</button>
    <p class="mt-3">Have an account? <a href="/login">Login</a></p>
</form>

<script>
    function togglePasswordVisibility(inputId) {
    var input = document.getElementById(inputId);
    var icon = document.querySelector("#" + inputId).nextElementSibling;

    if (input.type === "password") {
      input.type = "text";
      icon.innerHTML = "&#x1F440;"; // Show open eye
    } else {
      input.type = "password";
      icon.innerHTML = "&#x1F441;"; // Show closed eye
    }
  }



  function registerUser(event) {
    event.preventDefault(); // Prevent the default form submission

    var form = document.getElementById("registrationForm");
    var formData = new FormData(form);
    var json = {};

    formData.forEach(function (value, key) {
      json[key] = value;
    });

    // Validate email
    var emailInput = document.getElementById("email");
    if (!validateEmail(emailInput.value)) {
      alert("Invalid Email");
      return; // Stop registration process
    }

    // Validate password confirmation
    var password = document.getElementById("password").value;
    var confirmPassword = document.getElementById("confirm_password").value;
    if (password !== confirmPassword) {
      alert("Passwords do not match");
      return; // Stop registration process
    }

    fetch("/user", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(json),
    })
      .then((response) => {
        if (response.ok) {
          alert("Registration successful!"); // Show success message
          window.location.href = "/login"; // Redirect to login route after successful registration
        } else {
          throw new Error("Registration failed. Please try again."); // Error response
        }
      })
      .then((data) => {
        // Handle success response
        console.log(data);
        alert("Registration successful"); // Show success message
        window.location.href = "/login"; // Redirect to login route after successful registration
        // Reset form fields
        form.reset();
      })
      .catch((error) => {
        // Handle error response
        console.error("Error:", error);
        alert(error.message); // Show error message
      });
  }

  // Custom email validation function
  function validateEmail(email) {
    return email.endsWith("@nucleusteq.com");
  }
  // Function to populate department options
  function populateDepartments() {
    fetch("/department")
      .then((response) => response.json())
      .then((data) => {
        const departmentSelect = document.getElementById("department");
        data.forEach((department) => {
          const option = document.createElement("option");
          option.text = department.name;
          option.value = department.id;
          departmentSelect.appendChild(option);
        });
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }

  // Populate department options when the page loads
  window.onload = function () {
    populateDepartments();
  };
</script>
{% endblock %}
